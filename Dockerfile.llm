# Dockerfile for Unsloth LLM Training Environment
# Supports GPU training with CUDA

FROM nvidia/cuda:11.8.0-cudnn8-runtime-ubuntu22.04

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV DEBIAN_FRONTEND=noninteractive
ENV APP_HOME=/app
WORKDIR $APP_HOME

# Install system dependencies
RUN apt-get update && apt-get install -y \
    python3.10 \
    python3-pip \
    git \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Upgrade pip
RUN pip3 install --upgrade pip

# Install PyTorch with CUDA 11.8 support
RUN pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# Install Unsloth and dependencies
# Note: Adjust cu118 to match your CUDA version (cu121 for CUDA 12.1, etc.)
RUN pip3 install --upgrade "unsloth[cu118] @ git+https://github.com/unslothai/unsloth.git" || \
    pip3 install --upgrade "unsloth @ git+https://github.com/unslothai/unsloth.git"

# Install other training dependencies
RUN pip3 install \
    transformers>=4.35.0 \
    datasets>=2.14.0 \
    trl>=0.7.0 \
    peft>=0.6.0 \
    accelerate>=0.24.0 \
    bitsandbytes>=0.41.0 \
    xformers>=0.0.22 \
    tqdm>=4.66.0

# Copy application code
COPY . $APP_HOME/

# Create directories for models and data
RUN mkdir -p $APP_HOME/models $APP_HOME/data

# Expose port (if running training API)
EXPOSE 8000

# Default command (can be overridden)
CMD ["python3", "unsloth/train_unsloth_fast.py", "--help"]

